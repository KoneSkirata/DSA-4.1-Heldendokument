<!doctype html>
<html lang="de">
  <head>
    <title>DSA 4.1 Heldendokument-Generator</title>
    <style>
      .btn-wrapper {
        display: flex;
        justify-content: space-between;
      }
      form#import-form {
        border: 1px solid #333;
        padding: .5em;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-block-end: 2em;
      }
      form#import-form label {
        text-align: center;
        font-weight: bold;
        font-size: large;
        display: block;
      }
      form#import-form input {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      form#main {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      form#main textarea {
        flex-grow: 1;
      }
      html {
        margin: 0;
      }
      body {
        min-height: 100vh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: .5em;
      }
      #overlay {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1;
        background-color: rgba(0, 0, 0, 0.5);
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        min-height: 100vh;
      }
      #msg {
        text-align: center;
        padding: .5em;
        border-radius: .5em;
        background-color: white;
        z-index: 2;
      }
      #errorDisplay {
        min-width: 80vw;
        min-height: 80vh;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>DSA 4.1 Heldendokument-Generator</h1>

      <form method="post" action="/import" id="import-form" enctype="multipart/form-data">
        <label>Held aus Heldensoftware importieren </label>
        <input id="import" type="file" name="data" />
      </form>
    </header>
    <form id="main">
      <div class="btn-wrapper">
        <button type="submit">Generieren</button>
        <div>
          Lade ein Template:
          <button type="button" id="profan">Profan</button>
          <button type="button" id="geweiht">Geweiht</button>
          <button type="button" id="magier">Magier</button>
        </div>
      </div>

      <br/>
      <textarea name="data" id="data"></textarea>
    </form>
    <div id="overlay" style="display: none;">
      <div id="msg">
        <div id="processing">
          <p>Dokument wird erstellt, bitte warten (kann etwas dauern)</p>
          <progress id="progress" max="100"></progress>
        </div>
        <div id="error" style="display: none;">
          <p>Fehler beim Verarbeiten! Ausgabe unten. <button id="closeError">Schlie√üen</button></p>
          <textarea id="errorDisplay"></textarea>
        </div>
      </div>
    </div>

    <script type="text/javascript">

      function fillFrom() {
        fetch(new Request("/" + this.id)).then(resp => {
          if (resp.ok) {
            resp.text().then(content => {
              document.getElementById("data").value = content;
            });
          }
        });
      }

      document.getElementById("profan").onclick = fillFrom;
      document.getElementById("geweiht").onclick = fillFrom;
      document.getElementById("magier").onclick = fillFrom;
      document.getElementById("import").onchange = function(e) {
        e.preventDefault();
        let formData = new FormData();
        formData.append("data", this.files[0]);
        fetch("/import", {
            method: 'POST',
            body: formData
        }).then((resp) => {
            return resp.text();
        }).then((body) => {
            document.getElementById("data").value = body;
        }).catch((error) => {
            console.log(error);
        });
        this.value = null;
      }
      document.getElementById("main").onsubmit = function(e) {
        const overlay = document.getElementById("overlay");
        const progress = document.getElementById("progress");
        const input = this.elements["data"].value;
        const loc = window.location;
        let ws_uri = (loc.protocol === "https:") ? "wss:" : "ws:";
        ws_uri += "//" + loc.host + "/process";
        socket = new WebSocket(ws_uri);
        socket.binaryType = "arraybuffer";
        socket.addEventListener("error", function (event) {
          console.group("websocket error!");
          console.error(event);
          console.groupEnd();
        });
        socket.addEventListener('open', function (event) {
          progress.value = "";
          overlay.style.display = "flex";
          socket.send(input);
        });
        socket.addEventListener('message', function (event) {
          const arr = new Uint8Array(event.data);
          const status = arr[arr.length - 1];
          switch (status) {
            case 0:
              progress.value = arr[0];
              return false;
            case 1:
              document.getElementById("errorDisplay").value = new TextDecoder().decode(arr.slice(0, arr.length - 1));
              document.getElementById("error").style.display = "";
              document.getElementById("processing").style.display = "none";
              return true;
            case 2:
              const link = document.createElement("a");
              const pdf = new Blob([arr.slice(0, arr.length - 1)], {type: 'octet/stream'});
              const url = URL.createObjectURL(pdf)
              link.href = url;
              link.download = "heldendokument.pdf";
              link.click();
              URL.revokeObjectURL(url);
              break;
          }
          overlay.style.display = "none";
          return true;
        });
        return false;
      }
      document.getElementById("closeError").onclick = function(event) {
        document.getElementById("error").style.display = "none";
        document.getElementById("processing").style.display = "";
        document.getElementById("overlay").style.display = "none";
      }
    </script>
  </body>
</html>