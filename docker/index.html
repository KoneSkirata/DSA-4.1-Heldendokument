<!doctype html>
<html lang="de">
  <head>
    <title>DSA 4.1 Heldendokument-Generator</title>
    <style>
      .btn-wrapper {
        display: flex;
        justify-content: space-between;
      }
      h1 {
        font-size: larger;
        margin: .5em;
      }
      .step {
        display: flex;
        align-items: stretch;
        margin: 0 .5em .5em .5em;
        padding: 0;
      }
      .step > h2 {
        flex-shrink: 0;
        background-color: coral;
        border-top-left-radius: 3px;
        border-bottom-left-radius: 3px;
        padding: .5em;
        margin: 0;
        font-size: large;
      }
      .step > .options {
        flex-grow: 1;
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        align-items: center;
        background-color: bisque;
        padding: 3px;
        border-top-right-radius: 3px;
        border-bottom-right-radius: 3px;
      }
      .step p {
        margin: 0.25em;
        max-width: 720px;
        text-align: justify;
      }
      .options {
        flex: 1 1 200px;
      }
      strong.option {
        flex-shrink: 0;
        padding-left: 1em;
        padding-right: 1em;
      }
      p.option {
        flex-shrink: 1;
      }
      .options p,
      .options label {
        padding: 0 .5em;
      }
      .option label {
        text-align: center;
        display: block;
      }
      .option input,
      .option .btns {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      form#main {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      form#main textarea {
        flex-grow: 1;
      }
      html {
        margin: 0;
      }
      body {
        min-height: 100vh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: .5em;
      }
      #overlay {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1;
        background-color: rgba(0, 0, 0, 0.5);
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        min-height: 100vh;
      }
      #msg {
        text-align: center;
        padding: .5em;
        border-radius: .5em;
        background-color: white;
        z-index: 2;
      }
      #errorDisplay {
        min-width: 80vw;
        min-height: 80vh;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>DSA 4.1 Heldendokument-Generator</h1>
    </header>
    <section class="step">
      <h2>Schritt 1</h2>
      <div class="options">
        <form method="post" action="/import" id="import-form" enctype="multipart/form-data" class="option">
          <label>Importiere einen Held aus der Heldensoftware</label>
          <input id="import" type="file" name="data" />
        </form>
        <strong class="option">oder</strong>
        <div class="option">
          <label>Lade ein Template</label>
          <div class="btns">
            <button type="button" id="profan">Profan</button>
            <button type="button" id="geweiht">Geweiht</button>
            <button type="button" id="magier">Magier</button>
          </div>
        </div>
        <strong class="option">oder</strong>
        <p class="option">Fange mit einer leeren Datei an.</p>
      </div>
    </section>
    <section class="step">
      <h2>Schritt 2</h2>
      <div class="options">
        <div class="option">
          <p>Sofern du den Helden nicht immer wieder neu aus der Heldensoftware importieren willst, solltest du eine <code>.lua</code> Datei bei dir lokal anlegen.
          Der Generator speichert deine Eingabe nicht, sie ist weg wenn du die Seite neu lädst!</p>
          <p>Zum Editieren der Werte bietet sich ein Code-Editor an, der die Programmiersprache <em>Lua</em> beherrscht (das Textfeld unten kann natürlich zum editieren verwendet werden, ist aber mehr zum rein- und rauskopieren gedacht).
          Die Eingabe ist vom Format her Lua; du musst aber nicht programmieren können und hast auch keinen Zugriff auf die Lua-Standardfunktionen.</p>
          <p>Editiere die Werte nach Wunsch und speichere sie in die Datei.
          Die Dokumentation der Eingabestruktur findest du <a href="https://flyx.github.io/DSA-4.1-Heldendokument/">hier</a>.
          Kopiere danach den Dateiinhalt in das Textfeld unten.</p>
        </div>
      </div>
    </section>
    <form id="main">
      <section class="step">
        <h2>Schritt 3</h2>
        <div class="options">
          <p>Wenn du die Daten fertig editiert und in das Textfeld unten kopiert hast, klicke auf</p>
          <button type="submit">Generieren</button>
          <p>Dies kann mehrere Minuten dauern, dann gibt dein Browser dir einen Speichern-Dialog.</p>
          <p>Hinweis: Das Generieren scheint auf mobilen Endgeräten nicht zu funktionieren, ich weiß nicht warum.</p>
        </div>
      </section>
      <textarea name="data" id="data"></textarea>
    </form>
    <div id="overlay" style="display: none;">
      <div id="msg">
        <div id="processing">
          <p>Dokument wird erstellt, bitte warten (kann etwas dauern)</p>
          <progress id="progress" max="100"></progress>
        </div>
        <div id="error" style="display: none;">
          <p>Fehler beim Verarbeiten! Ausgabe unten. <button id="closeError">Schließen</button></p>
          <textarea id="errorDisplay"></textarea>
        </div>
      </div>
    </div>

    <script type="text/javascript">

      function fillFrom() {
        fetch(new Request("/" + this.id)).then(resp => {
          if (resp.ok) {
            resp.text().then(content => {
              document.getElementById("data").value = content;
            });
          }
        });
      }

      document.getElementById("profan").onclick = fillFrom;
      document.getElementById("geweiht").onclick = fillFrom;
      document.getElementById("magier").onclick = fillFrom;
      document.getElementById("import").onchange = function(e) {
        e.preventDefault();
        let formData = new FormData();
        formData.append("data", this.files[0]);
        fetch("/import", {
            method: 'POST',
            body: formData
        }).then((resp) => {
            return resp.text();
        }).then((body) => {
            document.getElementById("data").value = body;
        }).catch((error) => {
            console.log(error);
        });
        this.value = null;
      }
      document.getElementById("main").onsubmit = function(e) {
        const overlay = document.getElementById("overlay");
        const progress = document.getElementById("progress");
        const input = this.elements["data"].value;
        const loc = window.location;
        let ws_uri = (loc.protocol === "https:") ? "wss:" : "ws:";
        ws_uri += "//" + loc.host + "/process";
        socket = new WebSocket(ws_uri);
        socket.binaryType = "arraybuffer";
        socket.addEventListener("error", function (event) {
          console.group("websocket error!");
          console.error(event);
          console.groupEnd();
        });
        socket.addEventListener('open', function (event) {
          progress.value = "";
          overlay.style.display = "flex";
          socket.send(input);
        });
        socket.addEventListener('message', function (event) {
          const arr = new Uint8Array(event.data);
          const status = arr[arr.length - 1];
          switch (status) {
            case 0:
              progress.value = arr[0];
              return false;
            case 1:
              document.getElementById("errorDisplay").value = new TextDecoder().decode(arr.slice(0, arr.length - 1));
              document.getElementById("error").style.display = "";
              document.getElementById("processing").style.display = "none";
              return true;
            case 2:
              const link = document.createElement("a");
              const pdf = new Blob([arr.slice(0, arr.length - 1)], {type: 'octet/stream'});
              const url = URL.createObjectURL(pdf)
              link.href = url;
              link.download = "heldendokument.pdf";
              link.click();
              URL.revokeObjectURL(url);
              break;
            case 3:
              document.getElementById("errorDisplay").value = "Server überlastet – bitte versuche es später noch einmal.";
              document.getElementById("error").style.display = "";
              document.getElementById("processing").style.display = "none";
              return true;
          }
          overlay.style.display = "none";
          return true;
        });
        return false;
      }
      document.getElementById("closeError").onclick = function(event) {
        document.getElementById("error").style.display = "none";
        document.getElementById("processing").style.display = "";
        document.getElementById("overlay").style.display = "none";
      }
    </script>
  </body>
</html>